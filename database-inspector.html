<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELKAWERA Database Inspector</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: #fff;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #00ff9d;
            border-bottom: 2px solid #00ff9d;
            padding-bottom: 10px;
        }

        h2 {
            color: #00ff9d;
            margin-top: 30px;
        }

        .section {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        th {
            background: #00ff9d;
            color: #000;
            font-weight: bold;
        }

        tr:hover {
            background: #222;
        }

        .warning {
            background: #ff6b6b;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .success {
            background: #00ff9d;
            color: #000;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }

        .info {
            background: #4dabf7;
            color: #000;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        button {
            background: #00ff9d;
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
        }

        button:hover {
            background: #fff;
        }

        .stat-box {
            display: inline-block;
            background: #00ff9d;
            color: #000;
            padding: 15px 25px;
            border-radius: 8px;
            margin: 10px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
        }

        code {
            background: #000;
            padding: 2px 6px;
            border-radius: 3px;
            color: #00ff9d;
        }
    </style>
</head>

<body>
    <h1>üîç ELKAWERA Database Inspector</h1>
    <p>This tool helps you inspect and fix the Squad Dashboard issue</p>

    <div class="section">
        <h2>üìä Database Statistics</h2>
        <div id="stats"></div>
    </div>

    <div class="section">
        <h2>üë• Teams</h2>
        <div id="teams"></div>
    </div>

    <div class="section">
        <h2>üé¥ Players</h2>
        <div id="players"></div>
    </div>

    <div class="section">
        <h2>üë§ Users</h2>
        <div id="users"></div>
    </div>

    <div class="section">
        <h2>üîß Quick Fixes</h2>
        <div id="fixes">
            <button onclick="assignAllPlayersToFirstTeam()">Assign All Players to First Team</button>
            <button onclick="showUnassignedPlayers()">Show Unassigned Players</button>
            <button onclick="refreshData()">Refresh Data</button>
        </div>
        <div id="fixResults"></div>
    </div>

    <script>
        // Open IndexedDB
        const openDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('ElkaweraDB', 1);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        };

        // Get all records from a store
        const getAllFromStore = async (storeName) => {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        };

        // Update a record
        const updateRecord = async (storeName, record) => {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(record);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        };

        // Load and display data
        async function loadData() {
            try {
                const [players, teams, users] = await Promise.all([
                    getAllFromStore('players'),
                    getAllFromStore('teams'),
                    getAllFromStore('users')
                ]);

                // Display stats
                const playersWithTeam = players.filter(p => p.teamId);
                const playersWithoutTeam = players.filter(p => !p.teamId);
                const captains = users.filter(u => u.role === 'captain');

                document.getElementById('stats').innerHTML = `
                    <div class="stat-box">
                        <div class="stat-label">Total Players</div>
                        <div class="stat-value">${players.length}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Players with Team</div>
                        <div class="stat-value">${playersWithTeam.length}</div>
                    </div>
                    <div class="stat-box" style="background: ${playersWithoutTeam.length > 0 ? '#ff6b6b' : '#00ff9d'}">
                        <div class="stat-label">Players WITHOUT Team</div>
                        <div class="stat-value">${playersWithoutTeam.length}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Total Teams</div>
                        <div class="stat-value">${teams.length}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Captains</div>
                        <div class="stat-value">${captains.length}</div>
                    </div>
                `;

                if (playersWithoutTeam.length > 0) {
                    document.getElementById('stats').innerHTML += `
                        <div class="warning">
                            ‚ö†Ô∏è <strong>${playersWithoutTeam.length} players are not assigned to any team!</strong><br>
                            This is why the Squad Dashboard is empty. Players need a <code>teamId</code> to appear in captain dashboards.
                        </div>
                    `;
                }

                // Display teams
                let teamsHTML = '<table><tr><th>Team Name</th><th>Short Name</th><th>Captain</th><th>Team ID</th><th>Players Count</th></tr>';
                teams.forEach(team => {
                    const teamPlayers = players.filter(p => p.teamId === team.id);
                    const captain = users.find(u => u.id === team.captainId);
                    teamsHTML += `
                        <tr>
                            <td><strong>${team.name}</strong></td>
                            <td>${team.shortName}</td>
                            <td>${captain ? captain.name : 'Unknown'}</td>
                            <td><code>${team.id.substring(0, 8)}...</code></td>
                            <td><strong>${teamPlayers.length}</strong> players</td>
                        </tr>
                    `;
                });
                teamsHTML += '</table>';
                document.getElementById('teams').innerHTML = teamsHTML;

                // Display players
                let playersHTML = '<table><tr><th>Name</th><th>Position</th><th>Overall</th><th>Team ID</th><th>Team Name</th><th>Status</th></tr>';
                players.forEach(player => {
                    const team = teams.find(t => t.id === player.teamId);
                    const hasTeam = !!player.teamId;
                    playersHTML += `
                        <tr style="background: ${hasTeam ? 'inherit' : '#ff6b6b22'}">
                            <td><strong>${player.name}</strong></td>
                            <td>${player.position}</td>
                            <td>${player.overallScore}</td>
                            <td><code>${player.teamId ? player.teamId.substring(0, 8) + '...' : 'NONE'}</code></td>
                            <td>${team ? team.name : '<span style="color: #ff6b6b">No Team</span>'}</td>
                            <td>${hasTeam ? '<span style="color: #00ff9d">‚úì Assigned</span>' : '<span style="color: #ff6b6b">‚úó Unassigned</span>'}</td>
                        </tr>
                    `;
                });
                playersHTML += '</table>';
                document.getElementById('players').innerHTML = playersHTML;

                // Display users
                let usersHTML = '<table><tr><th>Name</th><th>Email</th><th>Role</th><th>Player Card ID</th></tr>';
                users.forEach(user => {
                    const hasCard = !!user.playerCardId;
                    usersHTML += `
                        <tr>
                            <td><strong>${user.name}</strong></td>
                            <td>${user.email}</td>
                            <td><span style="background: ${user.role === 'admin' ? '#9b59b6' : user.role === 'captain' ? '#3498db' : '#95a5a6'}; padding: 4px 8px; border-radius: 4px;">${user.role}</span></td>
                            <td>${hasCard ? '<span style="color: #00ff9d">‚úì Has Card</span>' : '<span style="color: #888">No Card</span>'}</td>
                        </tr>
                    `;
                });
                usersHTML += '</table>';
                document.getElementById('users').innerHTML = usersHTML;

            } catch (error) {
                console.error('Error loading data:', error);
                alert('Error loading database: ' + error.message);
            }
        }

        async function assignAllPlayersToFirstTeam() {
            try {
                const [players, teams] = await Promise.all([
                    getAllFromStore('players'),
                    getAllFromStore('teams')
                ]);

                if (teams.length === 0) {
                    alert('No teams found! Please create a team first.');
                    return;
                }

                const firstTeam = teams[0];
                const unassignedPlayers = players.filter(p => !p.teamId);

                if (unassignedPlayers.length === 0) {
                    alert('All players are already assigned to teams!');
                    return;
                }

                if (!confirm(`Assign ${unassignedPlayers.length} unassigned players to "${firstTeam.name}"?`)) {
                    return;
                }

                for (const player of unassignedPlayers) {
                    player.teamId = firstTeam.id;
                    await updateRecord('players', player);
                }

                document.getElementById('fixResults').innerHTML = `
                    <div class="success">
                        ‚úÖ Successfully assigned ${unassignedPlayers.length} players to "${firstTeam.name}"!<br>
                        Refresh the Captain Dashboard to see the changes.
                    </div>
                `;

                loadData();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function showUnassignedPlayers() {
            const players = await getAllFromStore('players');
            const unassigned = players.filter(p => !p.teamId);

            if (unassigned.length === 0) {
                document.getElementById('fixResults').innerHTML = `
                    <div class="success">‚úÖ All players are assigned to teams!</div>
                `;
            } else {
                let html = `<div class="warning"><strong>Unassigned Players (${unassigned.length}):</strong><ul>`;
                unassigned.forEach(p => {
                    html += `<li>${p.name} (${p.position}, OVR: ${p.overallScore})</li>`;
                });
                html += '</ul></div>';
                document.getElementById('fixResults').innerHTML = html;
            }
        }

        function refreshData() {
            loadData();
            document.getElementById('fixResults').innerHTML = `
                <div class="info">üîÑ Data refreshed!</div>
            `;
        }

        // Load data on page load
        loadData();
    </script>
</body>

</html>